<?php
namespace IndexTrade;
 
error_reporting(E_ERROR | E_WARNING | E_PARSE);
date_default_timezone_set('UTC');
clearstatcache(true);

include_once( __DIR__ . '/__bootstrap.php');

$log = initLog('idxtTradingApp');

use \Psr\Http\Message\ServerRequestInterface as Request;
use \Psr\Http\Message\ResponseInterface as Response;
use Centrifugo\Centrifugo;
use Ramsey\Uuid;

/**
echo "\n\n";
echo "     ---| IndexTrade.Exchange Platform via CoinIndex Team with LOVE |--- \n\n";
echo "Starting at: " . date('r') . "\n";
echo "Starting ExecutionReports Master...\n\n";
**/

$container = new \Slim\Container;


$container['redis'] = function ($container) {
    return initRedis();
};

$container['ssdb'] = function ($container) {
    return initSSDB();
};

$container['db'] = function ($container) {
    return initDB();
};


//$container['settings'] = Array('displayErrorDetails' => true);

$app = new \Slim\App($container);

$app->get('/hello', function (Request $request, Response $response, array $args) {
    $redis = $this->get('redis');
	$books = $redis->hgetall('INDEXTRDADE_MARKET_VIEW');
	//var_dump( $redis ); exit();
	
	$resp = $response->withJson($books, 200);
	//getBody()->write( $redis->info() );

    return $resp;
});




//создание ордера 
$app->post('/orders/new', function (Request $request, Response $response, array $args) {
    if ($request->getOriginalMethod() !== 'POST'){
		return $response->withJson(Array('status' => 'ERROR', 'error' => 'Invalid method', 'data' => null), 200);
	}
	
	$quote = $request->getParsedBody();
	$uid = 42;
	
	if (empty($quote)){
		return $response->withJson(Array('status' => 'ERROR', 'error' => 'Invalid body', 'data' => null), 200);
	}
	
	if (is_numeric($quote['price']) && is_numeric($quote['amount']) && is_string($quote['side']) && is_string($quote['symbol'])){
		
		if (!in_array($quote['side'], Array('BUY', 'SELL'))){
			return $response->withJson(Array('status' => 'ERROR', 'error' => 'Invalid quote type', 'data' => $quote), 200);
		}
		
		//ну, пробуем создать ордер, зафиксировать его а дальше уже разбереться движок 
		$order = Array(
			'id'	=> \Ramsey\Uuid\Uuid::uuid4()->toString(),
			'uid' 	=> $uid,
			'pair' 	=> $quote['symbol'],
			'type'	=> 'LIMIT',
			'side'	=> $quote['side'],
			'exec' 	=> 'GTC',
			'price' => floatval($quote['price']) * 1000000000,
			'amount' => floatval($quote['amount']) * 1000000000,
			'tags'	=> Array(),
			'ts' => t()
		);
		
		$command = Array(
			'act' 	=> 'ADD',
			'body'	=> $order
		);
		
		//отправим репорт, что приняли 
		$ssdb = $this->get('ssdb');
		$report = Array('type' => 'PROPOSED', 'msg' => 'Order sended to API front-end', 'orderID' => $order['id'], 'raw' => $order, 'ts' => t());
		$ssdb->qpush_back('INDEXTRDADE_EXECUTION_REPORTS', json_encode($report));
		
		
		$redis = $this->get('redis');
		$redis->rpush( 'INDEXTRDADE_NEW_ORDERS_CH0',  json_encode($command));
		
		return $response->withJson(Array('status' => 'OK', 'error' => null, 'data' => Array('orderID' => $order['id'])), 200);
	}
	else {
		return $response->withJson(Array('status' => 'ERROR', 'error' => 'Invalid quote field type', 'data' => null), 200);
	}
	
	
	
	//$redis = $this->get('redis');
	//$books = $redis->hgetall('INDEXTRDADE_MARKET_VIEW');
	//var_dump( $redis ); exit();
	
	$resp = $response->withJson($request, 200);
	//getBody()->write( $redis->info() );

    return $resp;
});

//возвращает текущий маркет-вью по инструменту 
$app->get('/market/overview', function (Request $request, Response $response, array $args) {
    $symbol = $request->getQueryParam('symbol', null);
	
	if (empty($symbol)){
		return $response->withJson(Array('status' => 'ERROR', 'error' => 'Invalid symbol', 'data' => null), 200);
	}
	
	$symbol = strtoupper( $symbol );

	$redis = $this->get('redis');
	$mview = $redis->hget('INDEXTRDADE_MARKET_VIEW', $symbol);
	
	if (!empty($mview)){
		$mview = json_decode( $mview, true, 16 );
		
		return $response->withJson(Array('status' => 'OK', 'error' => null, 'data' => $mview), 200);
	}
	else
		return $response->withJson(Array('status' => 'ERROR', 'error' => 'Invalid market overview', 'data' => null), 200);
});


$app->run();

